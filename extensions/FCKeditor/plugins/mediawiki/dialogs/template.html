<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!--
 * FCKeditor - The text editor for Internet - http://www.fckeditor.net
 * Copyright (C) 2003-2007 Frederico Caldeira Knabben
 *
 * == BEGIN LICENSE ==
 *
 * Licensed under the terms of any of the following licenses at your
 * choice:
 *
 *  - GNU General Public License Version 2 or later (the "GPL")
 *    http://www.gnu.org/licenses/gpl.html
 *
 *  - GNU Lesser General Public License Version 2.1 or later (the "LGPL")
 *    http://www.gnu.org/licenses/lgpl.html
 *
 *  - Mozilla Public License Version 1.1 or later (the "MPL")
 *    http://www.mozilla.org/MPL/MPL-1.1.html
 *
 * == END LICENSE ==
 *
 * Link dialog window.
-->
<html>
<head>
	<title>Template Properties</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="robots" content="noindex, nofollow" />
	<script type="text/javascript">

var oEditor		= window.parent.InnerDialogLoaded() ;
var FCK			= oEditor.FCK ;
var FCKLang		= oEditor.FCKLang ;
var FCKConfig	= oEditor.FCKConfig ;
var FCKRegexLib	= oEditor.FCKRegexLib ;
var FCKTools	= oEditor.FCKTools ;

document.write( '<script src="' + FCKConfig.BasePath + 'dialog/common/fck_dialog_common.js" type="text/javascript"><\/script>' ) ;

	</script>
	<script type="text/javascript">

//#### Dialog Tabs

// Set the dialog tabs.
window.parent.AddTab( 'Info', 'Info' ) ;
window.parent.AddTab( 'Form', 'Form' ) ;
window.parent.AddTab( 'Source', 'Source' ) ;

function OnDialogTabChange( tabCode )
{
	ShowE('divInfo'		, ( tabCode == 'Info' ) ) ;
	ShowE('divForm' 	, ( tabCode == 'Form' ) ) ;
        ShowE('divSource' 	, ( tabCode == 'Source' ) ) ;
}

// Get the selected flash embed (if available).
var oFakeImage = FCK.Selection.GetSelectedElement() ;
var oTemplateSpan ;
var sTemplateName ;

if ( oFakeImage )
{
	if ( oFakeImage.tagName == 'IMG' && oFakeImage.getAttribute('_fck_mw_template') )
		oTemplateSpan = FCK.GetRealElement( oFakeImage ) ;
	else
		oFakeImage = null ;
}

window.onload = function()
{
	// Translate the dialog box texts.
	oEditor.FCKLanguageManager.TranslatePage(document) ;

	// Load the selected link information (if any).
	LoadSelection() ;

        // Load template list
        LoadTemplateList();

	// Activate the "OK" button.
	window.parent.SetOkButton( true ) ;
	window.parent.SetAutoSize( true ) ;
}


function LoadSelection()
{
	if ( !oTemplateSpan ) return ;

	var inputText = FCKTools.HTMLDecode(oTemplateSpan.innerHTML);
	if (inputText.length>0 && inputText.indexOf('{{#')<0 && inputText.indexOf('{{:')<0 ) 
	{
                // cut template name until the first line break appears
		sTemplateName = inputText.substring(2,inputText.indexOf('fckLR'));
                // there was no line break? then templatename is upto the first | where params follow
		if (inputText.indexOf('fckLR')<1) 
			sTemplateName = inputText.substring(2,inputText.indexOf('|'));
                // no params eigther? then template name is up to the closing }}
		if (inputText.indexOf('|')<1) 
			sTemplateName = inputText.substring(2,inputText.indexOf('}}'));
                // capitalize the first letter of the name
		sTemplateName = sTemplateName.charAt(0).toUpperCase() + sTemplateName.substr(1)
                // set divInfo and divForm with data for current seleced template
		SetUrl('Template:' + sTemplateName);
	}
        // set template source code
	GetE('xTemplateRaw').value = inputText.replace(/fckLR/g,'\r\n').replace( /&quot;/g, '"' );
        // remove selection list
        var parentTd = GetE('divList').parentNode;
        var parentTr = parentTd.parentNode;
        parentTr.removeChild(parentTd);
        // show selected label on top
        GetE('divHeaderSelected').style.display = 'block';
        GetE('divHeaderSelected').innerHTML += ' ' + sTemplateName
}

function LoadFormForTemplate() {
	// Make an Ajax search for the pages.
	oEditor.window.parent.sajax_request_type = 'GET' ;
	oEditor.window.parent.sajax_do_call( 'wfSajaxFormForTemplateFCKeditor',[sTemplateName], SetFormForTemplate ) ;
}

function SetFormForTemplate(result) {
	var results = result.responseText.Trim().split( '\n' ) ;

        if ( results.length > 0 && results[0].length > 0 ) {
            //http://localhost/wiki/index.php/Special:EditDataEmbedded/Form_name/page_name?page=plain
            var url = oEditor.window.parent.wgServer
                    + oEditor.window.parent.wgScript
                    + '/Special:EditDataEmbedded/'
                    + results[0].substr(results[0].indexOf(':') + 1).replace(' ', '_')
                    + '/'
                    + oEditor.window.parent.wgPageName.replace(' ', '_')
                    + '?page=plain';
            SetAttribute(GetE('xTemplateForm'), 'src', url);
	}
        else {
            // set table border thick
            GetE('xTemplateForm').parentNode.parentNode.parentNode.parentNode.border = '1';
            GetE('xTemplateForm').parentNode.innerHTML = 'There is no form to '
                + 'submit parameters for this template call. '
                + 'Please edit the source code directly.';
        }
}

function LoadTemplateList() {
        // check if the list is required anyway, if not just quit
        if (! GetE('xTemplateList')) return;
        
	// Make an Ajax search for the pages.
	oEditor.window.parent.sajax_request_type = 'GET' ;
	oEditor.window.parent.sajax_do_call( 'wfSajaxTemplateListFCKeditor',[oEditor.window.parent.wgPageName], FillTemplateList ) ;
}
function FillTemplateList(result) {
	var results = result.responseText.Trim().split( '\n' ) ;
	var select = GetE( 'xTemplateList' ) ;

	if ( results.length > 0 && !( results.length == 1 && results[0].length == 0 ) )
	{
		for ( var i = 0 ; i < results.length ; i++ ) {
                        var shownVal = (results[i].indexOf(':') != -1)
                                    ? results[i].substr(results[i].indexOf(':') + 1)
                                    : results[i];
			FCKTools.AddSelectOption( select, shownVal, results[i] ) ;
                        // select the current entry, when there is a selecion loaded
                        // actually it's not used anymore but left here
                        // incase someone needs it in future
                        if (sTemplateName && sTemplateName == shownVal)
                            document.getElementById('xTemplateList').childNodes[i + 1].setAttribute('selected', 'selected');
                }
	}

}
function SetUrl(tpage) {
    sTemplateName = tpage;
    LoadFormForTemplate();
    var urlTemplate = oEditor.window.parent.wgServer
        + oEditor.window.parent.wgScript
        + '?title=' + tpage + '&page=plain';
    SetAttribute(GetE('xTemplateManual'),'src',urlTemplate);
    GetE('xTemplateRaw').value = "{{" + tpage.substr(tpage.indexOf(':') + 1) + "}}";
}

//#### The OK button was hit.
function Ok()
{
	if ( !oTemplateSpan )
	{
		oTemplateSpan = FCK.EditorDocument.createElement( 'SPAN' ) ;
		oTemplateSpan.className = 'fck_mw_template' ;
	}
	
	var templateData = FCKTools.HTMLEncode(GetE('xTemplateRaw').value.Trim().replace(/(\r\n|\n)/g, 'fckLR')).replace( /"/g, '&quot;' ) ;
        var tooltip = FCKTools.HTMLEncode(GetE('xTemplateRaw').value.Trim());
	
	if ( !( /^{{[\s\S]+}}$/.test( templateData ) ) )
	{
		alert( 'Templates must start with {{ and end with }}. Please check it.' ) ;
		return false ;
	}
	
	oTemplateSpan.innerHTML = templateData ;

	if ( !oFakeImage )
	{
		oFakeImage	= oEditor.FCKDocumentProcessor_CreateFakeImage( 'FCK__MWTemplate', oTemplateSpan ) ;
		oFakeImage.setAttribute( '_fck_mw_template', 'true', 0 ) ;
                oFakeImage.setAttribute( 'title', tooltip);
                oFakeImage.setAttribute( 'alt', tooltip);
		oFakeImage	= FCK.InsertElement( oFakeImage ) ;
	}
        else {
                oFakeImage.setAttribute( 'title', tooltip);
                oFakeImage.setAttribute( 'alt', tooltip);
        }

	//GetE('xTestSpan').innerHTML = GetE('xTemplateRaw').value.Trim().replace( /"/g, '&quot;' ).replace(/(\r\n|\n)/g, '___') ;
	return true ;
}

	</script>
        <style type="text/css">
            .tmplTable {
                width: 100%;
                height: 100%;
                vertical-align: top;
            }
            .tmplTable table {
                border: 0;
                padding: 0;
                margin: 0;
            }
            .tmplDivOptionBox {
                height: 100%;
            }
        </style>
</head>
<body style="overflow: hidden">
    <div id="divLabelSeleced"></div>
    <table class="tmplTable">
        <tr>
            <td><div id="divHeaderSelected" style="display: none;"><b>Template selected:</b></div></td>
        </tr>
        <tr class="tmplTable">
            <td style="width: 30%; vertical-align: top;">
                <div id="divList" style="height: 100%; width: 100%;">
                    <b>Choose a template</b>
                    <select id="xTemplateList" onchange="SetUrl( this.value );" size="10" style="height: 100%; width: 100%;">
                    </select>
                </div>
            </td>
            <td valign="top">
                <div id="divInfo" class="tmplDivOptionBox">
                    <b>Template description</b>
                    <table class="tmplTable">
			<tr>
				<td class="tmplTable">
                                    <iframe id="xTemplateManual" width="100%" scrolling="yes" height="100%" src=""></iframe>
				</td>
			</tr>
                    </table>
                </div>
                <div id="divForm" class="tmplDivOptionBox" style="display: none">
                    <b>Fill the template with data</b>
                    <table class="tmplTable">
			<tr>
				<td class="tmplTable">
                                    <iframe id="xTemplateForm" scrolling="yes" width="100%" height="100%" src=""></iframe>
				</td>
			</tr>
                    </table>
                </div>
                <div id="divSource" class="tmplDivOptionBox" style="display: none">
                    <b>Template raw definition (from {{ to }})</b>
                    <table cellpadding="0" cellspacing="0" border="0" width="100%" height="100%">
			<tr>
				<td class="tmplTable">
					<textarea id="xTemplateRaw" style="width: 100%; height: 100%; font-family: Monospace"
						cols="50" rows="10" wrap="off"></textarea>
				</td>
			</tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>
